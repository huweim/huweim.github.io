<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>cmake 目录结构和使用 - Weiming Hu
</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=generator content="Hugo 0.140.2"><link rel=canonical href=https://huweim.github.io/post/%E5%B7%A5%E5%85%B7_cmake-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%92%8C%E4%BD%BF%E7%94%A8/><meta name=author content="Cory"><meta name=description content="0. 前言 cuTLASS 使用到了 cmake，之前没有接触过，先学习一下他的目录结构和编译过程。
2023-03-16 11:25:11，在学习一个工具时，Getting Started 或许是最快的入门方式。
"><meta name=keywords content="cmake"><meta property="og:url" content="https://huweim.github.io/post/%E5%B7%A5%E5%85%B7_cmake-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%92%8C%E4%BD%BF%E7%94%A8/"><meta property="og:site_name" content="Weiming Hu"><meta property="og:title" content="cmake 目录结构和使用"><meta property="og:description" content="0. 前言 cuTLASS 使用到了 cmake，之前没有接触过，先学习一下他的目录结构和编译过程。
2023-03-16 11:25:11，在学习一个工具时，Getting Started 或许是最快的入门方式。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-05-09T22:17:43+08:00"><meta property="article:modified_time" content="2023-03-23T14:17:43+08:00"><meta property="article:tag" content="Cmake"><meta itemprop=name content="cmake 目录结构和使用"><meta itemprop=description content="0. 前言 cuTLASS 使用到了 cmake，之前没有接触过，先学习一下他的目录结构和编译过程。
2023-03-16 11:25:11，在学习一个工具时，Getting Started 或许是最快的入门方式。"><meta itemprop=datePublished content="2022-05-09T22:17:43+08:00"><meta itemprop=dateModified content="2023-03-23T14:17:43+08:00"><meta itemprop=wordCount content="2248"><meta itemprop=keywords content="Cmake"><meta name=twitter:card content="summary"><meta name=twitter:title content="cmake 目录结构和使用"><meta name=twitter:description content="0. 前言 cuTLASS 使用到了 cmake，之前没有接触过，先学习一下他的目录结构和编译过程。
2023-03-16 11:25:11，在学习一个工具时，Getting Started 或许是最快的入门方式。"><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.de488e0d4b09a0b9f6412192239661fda9bb9ea66e49d8f210bf0786a4e36acb.css integrity="sha256-3kiODUsJoLn2QSGSI5Zh/am7nqZuSdjyEL8HhqTjass=" media=screen crossorigin=anonymous><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header class=site-header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>Weiming Hu</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://huweim.github.io/>Home</a></li><li class=menu-item><a class=menu-item-link href=https://huweim.github.io/post>All posts</a></li><li class=menu-item><a class=menu-item-link href=https://huweim.github.io/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=https://huweim.github.io/archives>Archives</a></li><li class=menu-item><a class=menu-item-link href=https://huweim.github.io/tags>Tags</a></li><li class=menu-item><a class=menu-item-link href=https://huweim.github.io/about/>About</a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg><svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=menu-item><a class=menu-item-link href=https://huweim.github.io/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon><svg aria-hidden="true" class="lucide lucide-menu hi-svg-inline icon--menu" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></div><div class=mobile-navbar-logo><a href=/ class=logo>Weiming Hu</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=https://huweim.github.io/>Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://huweim.github.io/post>All posts</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://huweim.github.io/categories/>Categories</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://huweim.github.io/archives>Archives</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://huweim.github.io/tags>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://huweim.github.io/about/>About</a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg><svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=mobile-menu-item><a class=menu-item-link href=https://huweim.github.io/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=sidebar></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>cmake 目录结构和使用</h1><div class=post-meta-list><div class="post-meta-item post-meta-author"><svg aria-hidden="true" class="lucide lucide-user-round-pen hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M2 21a8 8 0 0110.821-7.487"/><path d="M21.378 16.626a1 1 0 00-3.004-3.004l-4.01 4.012a2 2 0 00-.506.854l-.837 2.87a.5.5.0 00.62.62l2.87-.837a2 2 0 00.854-.506z"/><circle cx="10" cy="8" r="5"/></svg>
Cory</div><div class="post-meta-item post-meta-time"><svg aria-hidden="true" class="lucide lucide-calendar-days hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
<time datetime=2022-05-09>2022-05-09
</time><span class="post-meta-item post-meta-lastmod">(LastMod:
2023-03-23)</span></div><div class=post-meta__right><span class=post-meta-more>2248 words -
5 min read</span><div class="post-meta-item post-meta-category"><a href=https://huweim.github.io/categories/%E7%BC%96%E7%A8%8B/>编程</a></div></div></div></header><div class=post-content><h1 id=0-前言>0. 前言</h1><p>cuTLASS 使用到了 cmake，之前没有接触过，先学习一下他的目录结构和编译过程。</p><p>2023-03-16 11:25:11，在学习一个工具时，Getting Started 或许是最快的入门方式。</p><h2 id=01-cmake-简介>0.1 Cmake 简介</h2><p>对于 C++ 程序，手动编写 Makefile 非常麻烦。cmake 用于自动编写 Makefile。通过读取 CMakeLists.txt 文件，可以自动生成 make 文件。cmake 中 macro 和 function 的使用，使得 cmake 更像是一个脚本语言。</p><h2 id=02-安装>0.2 安装</h2><p>官方给出了建议的环境，cmake 没有安装，apt-get install 安装的是 3.12 版本，不符合要求。手动安装一下 3.20 cmake，<a href=https://gist.github.com/bmegli/4049b7394f9cfa016c24ed67e5041930>教程</a></p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># get and build CMake</span>
</span></span><span style=display:flex><span>wget https://github.com/Kitware/CMake/releases/download/v3.24.0/cmake-3.24.0.tar.gz
</span></span><span style=display:flex><span>tar -zvxf cmake-3.24.0.tar.gz
</span></span><span style=display:flex><span>cd cmake-3.24.0
</span></span><span style=display:flex><span>./bootstrap
</span></span><span style=display:flex><span>make -j8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># add path</span>
</span></span><span style=display:flex><span>export PATH<span style=color:#f92672>=</span>$PATH:$CUDA_INSTALL_PATH/bin:~/cmake-3.24.0/bin</span></span></code></pre></div></div><p>注意有个 BUG，<code> Could NOT find OpenSSL,</code>，<code>apt-get install libssl-dev</code> 即可</p><h2 id=03-基本特性>0.3 基本特性</h2><p>cmake 命令不区分大小写，但是变量区分大小写。</p><h1 id=1-简介>1. 简介</h1><h2 id=11-带有-cmake-的项目>1.1 带有 cmake 的项目</h2><p>介绍最基本的，带有 cmake 的项目的整体结构</p><h3 id=111-目录结构>1.1.1 目录结构</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>|-- bin  <span style=color:#75715e>#存放可执行文件</span>
</span></span><span style=display:flex><span>|-- build  <span style=color:#75715e>#目录用于存放编译生成的文件</span>
</span></span><span style=display:flex><span>|  |-- dependencies  <span style=color:#75715e>#存放 external libraries or dependencies that are required by the project being built</span>
</span></span><span style=display:flex><span>|  |-- CMakeFiles
</span></span><span style=display:flex><span>|-- CMakeLists.txt
</span></span><span style=display:flex><span>|-- include  <span style=color:#75715e>#统一存放头文件</span>
</span></span><span style=display:flex><span>|  |-- hello.h
</span></span><span style=display:flex><span>|  |-- gpgpu.h
</span></span><span style=display:flex><span>|-- lib
</span></span><span style=display:flex><span>|-- README.md
</span></span><span style=display:flex><span>|-- src
</span></span><span style=display:flex><span>|  |-- CMakeLists.txt
</span></span><span style=display:flex><span>|  |-- main.cpp
</span></span><span style=display:flex><span>|  |-- model1
</span></span><span style=display:flex><span>|  |  |-- CMakeLists.txt
</span></span><span style=display:flex><span>|  |  |-- gpgpu.cpp
</span></span><span style=display:flex><span>|  |  |-- model.cpp
</span></span><span style=display:flex><span>|  |-- model2
</span></span><span style=display:flex><span>|  |  |-- CMakeLists.txt
</span></span><span style=display:flex><span>|  |  |-- hello.cpp
</span></span><span style=display:flex><span>|  |  |-- model.cpp</span></span></code></pre></div></div><p>对于大一点的项目可能还会需要 util 目录，library 目录夹或者 tool 目录</p><p><strong>src</strong>: 这个 example 包含了 2 models，main.cpp 依赖于 2 基础 models，另外，注意到他们都包含 <code>CMakeLists.txt</code> 文件</p><h2 id=112-理解-cmakeliststxt>1.1.2 理解 CMakeLists.txt</h2><p>注意 cmake 文件中不区分大小写</p><blockquote><p>In a CMake-based project, each directory containing C++ source code should contain a CMakeLists.txt file. This file describes the rules for building the code in that directory.</p></blockquote><p>2023-03-16 14:19:11，每个 dir 下都要有一个 CMakeLists.txt</p><p>最基础的包含以下一些信息，</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 规定该CMakeLists.txt适用的cmake最小版本，这里是 3.12，自己手动安装了 3.20 版本</span>
</span></span><span style=display:flex><span>cmake_minimum_required<span style=color:#f92672>(</span>VERSION 3.12.4 FATAL_ERROR<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 项目名称，也就是 cutlass</span>
</span></span><span style=display:flex><span>project<span style=color:#f92672>(</span>CUTLASS VERSION 2.9.0 LANGUAGES CXX<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 定义生成的可执行文件(程序)的名称，假设为 gemm</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这里没找到 cutlass 对应的，cutlass 中有一个 function(cutlass_add_executable_tests NAME TARGET)</span>
</span></span><span style=display:flex><span>add_executable <span style=color:#f92672>(</span>gemm gemm.cxx<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 指定头文件搜索路径，根目录下 include</span>
</span></span><span style=display:flex><span>include_directories <span style=color:#f92672>(</span>include<span style=color:#f92672>)</span></span></span></code></pre></div></div><h2 id=12-cmake-编译过程>1.2 cmake 编译过程</h2><h3 id=121-build-编译并运行>1.2.1 build, 编译并运行</h3><p>build 目录用于存放编译生成的文件，一般的编译过程：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ mkdir build <span style=color:#f92672>&amp;&amp;</span> cd build
</span></span><span style=display:flex><span>$ cmake .. -DCUTLASS_NVCC_ARCHS<span style=color:#f92672>=</span><span style=color:#ae81ff>75</span>  <span style=color:#75715e># compile for NVIDIA Turing GPU architecture</span></span></span></code></pre></div></div><h3 id=122-问题可执行程序在哪个目录生成>1.2.2 问题，可执行程序在哪个目录生成？</h3><p>看起来似乎是和 Makefile 文件同一目录，而 cutlass 中，执行 make 操作之后，会对程序进行编译，然后直接运行。由于在 sim 上运行需要把 gpgpusim.config 放到程序运行的目录下，所以我们需要知道是在哪个目录运行的。</p><p>cmake 设置 library and executable 文件的存放路径：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set<span style=color:#f92672>(</span>LIBRARY_OUTPUT_PATH path<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>set<span style=color:#f92672>(</span>EXECUTABLE_OUTPUT_PATH path<span style=color:#f92672>)</span></span></span></code></pre></div></div><blockquote><p>如果子目录中的某个CMakeLists.txt中设置了 set(&mldr;)，就以当前文件中设置的路径为主，否则以父目录中设置的路径为主</p></blockquote><p>如果都没设置呢？从简单的程序来看，在 <code>build</code> 目录下 <code>cmake .. XXXX</code>，在 <code>build</code> 目录下生成 Makefile，执行 <code>make & make install</code>，可执行程序就在当前（<code>build</code>） 目录下。</p><h3 id=123-cmake-文件变量赋值>1.2.3 cmake 文件变量赋值</h3><p>cutlass 编译 example 报错，不确定问题是不是出在变量的传递。</p><p>2023-03-14 15:49:24，似乎是编译 example 的方式不对。</p><h3 id=124-制定-cuda-编译器>1.2.4 制定 cuda 编译器</h3><p>使用 CMAKE_CUDA_COMPILER 这个内建变量可以做到。</p><p>可以通过命令 <code>cmake -DCMAKE_CUDA_COMPILER="xxx"</code> 来修改</p><h1 id=2-命令行参数编译选项-command-line-option>2. 命令行参数，编译选项 command line option</h1><h2 id=21--d>2.1 -D</h2><p>原来 -D 是一个传参选项，怪不得在 CMakeList 里面直接搜索 -DCUTLASS_NVCC_ARCHS，没有找到这个命令。</p><p>-D 的作用就是定义变量的默认值，比如 <code>-DCUTLASS_NVCC_ARCHS=75</code>，也就是定义了 <code>CUTLASS_NVCC_ARCHS</code> 的值</p><p>此外，<code>CUTLASS_NVCC_ARCHS</code> 的属性应该得是一个 CACHE STRING，否则可能无法被改变</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set<span style=color:#f92672>(</span>CUTLASS_NVCC_ARCHS <span style=color:#e6db74>${</span>CUTLASS_NVCC_ARCHS_SUPPORTED<span style=color:#e6db74>}</span> CACHE STRING <span style=color:#e6db74>&#34;The SM architectures requested.&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>set<span style=color:#f92672>(</span>CUTLASS_LIBRARY_KERNELS <span style=color:#e6db74>&#34;&#34;</span> CACHE STRING <span style=color:#e6db74>&#34;Comma delimited list of kernel name filters. If unspecified, only the largest tile size is enabled. If &#39;all&#39; is specified, all kernels are enabled.&#34;</span><span style=color:#f92672>)</span></span></span></code></pre></div></div><p>那么，尝试修改 <code>CMAKE_CUDA_ARCHITECTURES</code>，找到给其赋值，并且属性为 CACHE STRING 的 <code>TCNN_CUDA_ARCHITECTURES</code>，使用命令行实现：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cmake . -B build -DTCNN_CUDA_ARCHITECTURES<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;75&#34;</span></span></span></code></pre></div></div><h2 id=23-cmake_progress_start>2.3 cmake_progress_start</h2><h2 id=24--b-指定构建目录的路径--s-指定源代码目录>2.4 -B 指定构建目录的路径 -S 指定源代码目录</h2><p><code>/home/wmhu/cmake-3.24.0/bin/cmake -S/home/wmhu/work/tiny-cuda-nn -B/home/wmhu/work/tiny-cuda-nn/build --check-build-system CMakeFiles/Makefile.cmake 0</code></p><p><code>--check-build-system</code> 选项用于检查构建系统是否可用，以及检查是否需要重新构建</p><p>0 是一个可选的参数，用于设置生成Makefile时的调试级别。</p><h1 id=3-command-命令>3. Command 命令</h1><p>有点像函数，但是英文是 command</p><h2 id=31-set-系列>3.1 set 系列</h2><h3 id=311-set-normal-value>3.1.1 Set Normal Value</h3><p><code>set (&lt;variable> &lt;value>... [PARENT_SCOPE])</code>
<code>set(CMAKE_CXX_FLAGS "-std=c++11 ${CMAKE_CXX_FLAGS}")</code></p><blockquote><p>If the PARENT_SCOPE option is given the variable will be set in the scope above the current scope. Each new directory or function() command creates a new scope. A scope can also be created with the block() command.</p></blockquote><p>目前还没有太明白 scope 的概念。</p><h3 id=312-set-cache-entry>3.1.2 Set Cache Entry</h3><p><code>set(&lt;variable> &lt;value>... CACHE &lt;type> &lt;docstring> [FORCE])</code></p><p><code>FORCE</code> option to overwrite existing entries</p><h2 id=32-add-系列>3.2 add 系列</h2><h3 id=321-添加编译选项-add_compilie_options>3.2.1 添加编译选项 add_compilie_options</h3><p>对于 C/C++ 代码，一般来说，编译选项命名为 FLAG。可以通过 <code>add_compilie_options</code> 命令设置编译选项，也可以通过 <code>set</code> 命令修改 <code>CMAKE_CXX_FLAGS</code> 或者 <code>CMAKE_C_FLAGS</code>。</p><ul><li><code>add_compile_options</code> 添加的选项是针对所有编译器，包括 C 和 C++</li><li>set 命令设置的 <code>CMAKE_CXX_FLAGS</code> 或者 <code>CMAKE_C_FLAGS</code> 变量分别针对 C 和 C++</li></ul><p>e.g.</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#75715e>#判断编译器类型,如果是gcc编译器,则在编译选项中加入c++11支持
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>if(<span style=color:#e6db74>CMAKE_COMPILER_IS_GNUCXX</span>)<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    set(<span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>&#34;-std=c++11 ${CMAKE_CXX_FLAGS}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;optional:-std=c++11&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>endif(<span style=color:#e6db74>CMAKE_COMPILER_IS_GNUCXX</span>)<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>add_compile_options(<span style=color:#e6db74>&lt;option&gt;</span> <span style=color:#e6db74>...</span>)<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 例子
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>add_compile_options(<span style=color:#e6db74>-Wall</span> <span style=color:#e6db74>-Wextra</span> <span style=color:#e6db74>-pedantic</span> <span style=color:#e6db74>-Werror</span> <span style=color:#e6db74>-g</span>)</span></span></code></pre></div></div><h2 id=33-message>3.3 message</h2><p>这个函数的功能是打印</p><p><code>message(STATUS "Obtained CUDA architectures from CMake variable TCNN_CUDA_ARCHITECTURES=${TCNN_CUDA_ARCHITECTURES}")</code></p><h2 id=34-function>3.4 function</h2><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span>function(<span style=color:#e6db74>&lt;name&gt;</span> <span style=color:#e6db74>[&lt;arg1&gt;</span> <span style=color:#e6db74>...]</span>)<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>&lt;commands&gt;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>endfunction()</span></span></code></pre></div></div><p>NOTE: A function opens a new scope: see set(var PARENT_SCOPE) for details.</p><p>function 伴随 scope 的概念，或许可以用局部变量和全局变量去理解。</p><h2 id=35-list>3.5 list</h2><p>list 有很多子命令，包括 <code>APPEND</code>, <code>INSERT</code> 等，用于修改变量。</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span>if (<span style=color:#e6db74>MSVC</span>)<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	list(<span style=color:#e6db74>APPEND</span> <span style=color:#e6db74>CUDA_NVCC_FLAGS</span> <span style=color:#e6db74>&#34;-Xcompiler=/bigobj&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>else()<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	list(<span style=color:#e6db74>APPEND</span> <span style=color:#e6db74>CUDA_NVCC_FLAGS</span> <span style=color:#e6db74>&#34;-Xcompiler=-Wno-float-conversion&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	list(<span style=color:#e6db74>APPEND</span> <span style=color:#e6db74>CUDA_NVCC_FLAGS</span> <span style=color:#e6db74>&#34;-Xcompiler=-fno-strict-aliasing&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	list(<span style=color:#e6db74>APPEND</span> <span style=color:#e6db74>CUDA_NVCC_FLAGS</span> <span style=color:#e6db74>&#34;-Xcudafe=--diag_suppress=unrecognized_gcc_pragma&#34;</span>)</span></span></code></pre></div></div><h1 id=4-属性-property>4. 属性 Property</h1><p>在 CMake 中，Properties（属性）是一种用于设置目标属性的机制。一个目标可以有多个属性，每个属性有一个名称和一个值。</p><p>例如，一个目标可以有一个名为“CXX_STANDARD”的属性，其值为“11”。属性可以影响编译和链接过程中的行为，包括编译器和链接器选项、编译器和链接器特性，以及构建目标的方式。可以使用 set_target_properties() 命令来设置目标属性。</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span>set_target_properties(<span style=color:#e6db74>MyTarget</span> <span style=color:#e6db74>PROPERTIES</span> <span style=color:#e6db74>CXX_STANDARD</span> <span style=color:#e6db74>11</span>)</span></span></code></pre></div></div><h1 id=5-模块和包管理-module-package>5. 模块和包管理 module, package</h1><h1 id=object-file-and-link>Object file and link</h1><p>在目录 <code>mlp_learning_an_image.dir</code> 生成 <code>.o</code> 文件之后，同一个目录下有 <code>link.txt</code> 文件，这个文件就是用来进行链接的。</p><p>解析一下</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/usr/bin/c++ -O3 -DNDEBUG CMakeFiles/mlp_learning_an_image.dir/mlp_learning_an_image.cu.o CMakeFiles/mlp_learning_an_image.dir/__/dependencies/stbi/stbi_wrapper.cpp.o -o ../mlp_learning_an_image   -L/usr/local/cuda/targets/x86_64-linux/lib  ../libtiny-cuda-nn.a -lcuda ../dependencies/fmt/libfmt.a -lcudadevrt -lcudart_static -lrt -lpthread -ldl 
</span></span><span style=display:flex><span><span style=color:#75715e># ../libtiny-cuda-nn.a 这个是 tiny-cuda-nn 那一堆编译生成的，也会被链接进来</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nvcc -o mlp_learning_an_image CMakeFiles/mlp_learning_an_image.dir/mlp_learning_an_image.cu.o CMakeFiles/mlp_learning_an_image.dir/__/dependencies/stbi/stbi_wrapper.cpp.o -L/usr/local/cuda/targets/x86_64-linux/lib  ../libtiny-cuda-nn.a -lcuda ../dependencies/fmt/libfmt.a -lcudadevrt -lcudart_static -lrt -lpthread -ldl</span></span></code></pre></div></div><p><code>/usr/bin/ar qc libtiny-cuda-nn.a "CMakeFiles/tiny-cuda-nn.dir/src/common.cu.o"...</code>，<code>ar</code> 命令用于创建和管理 static lib, qc 是其 opti</p><h1 id=reference>Reference</h1><p><a href=https://zhuanlan.zhihu.com/p/93895403>https://zhuanlan.zhihu.com/p/93895403</a></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>Cory</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2023-03-23</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=https://huweim.github.io/tags/cmake/>cmake</a></div><nav class=post-nav><a class=prev href=/post/%E6%80%BB%E7%BB%93_%E8%BD%AC%E8%BD%BDmlsys-%E4%B8%AA%E6%96%B9%E5%90%91%E7%BB%BC%E8%BF%B0/><i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-left hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m15 18-6-6 6-6"/></svg>
</i><span class="prev-text nav-default">（转载）MLSys 个方向综述</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/blog_hugo_%E8%AE%A9%E4%BD%A0%E7%9A%84%E5%8D%9A%E5%AE%A2%E8%A2%ABgoogle%E6%94%B6%E5%BD%95/><span class="next-text nav-default">Hugo_让你的博客被Google收录</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-right hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m9 18 6-6-6-6"/></svg></i></a></nav></footer></article></div><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#0-前言>0. 前言</a><ul><li><a href=#01-cmake-简介>0.1 Cmake 简介</a></li><li><a href=#02-安装>0.2 安装</a></li><li><a href=#03-基本特性>0.3 基本特性</a></li></ul></li><li><a href=#1-简介>1. 简介</a><ul><li><a href=#11-带有-cmake-的项目>1.1 带有 cmake 的项目</a><ul><li><a href=#111-目录结构>1.1.1 目录结构</a></li></ul></li><li><a href=#112-理解-cmakeliststxt>1.1.2 理解 CMakeLists.txt</a></li><li><a href=#12-cmake-编译过程>1.2 cmake 编译过程</a><ul><li><a href=#121-build-编译并运行>1.2.1 build, 编译并运行</a></li><li><a href=#122-问题可执行程序在哪个目录生成>1.2.2 问题，可执行程序在哪个目录生成？</a></li><li><a href=#123-cmake-文件变量赋值>1.2.3 cmake 文件变量赋值</a></li><li><a href=#124-制定-cuda-编译器>1.2.4 制定 cuda 编译器</a></li></ul></li></ul></li><li><a href=#2-命令行参数编译选项-command-line-option>2. 命令行参数，编译选项 command line option</a><ul><li><a href=#21--d>2.1 -D</a></li><li><a href=#23-cmake_progress_start>2.3 cmake_progress_start</a></li><li><a href=#24--b-指定构建目录的路径--s-指定源代码目录>2.4 -B 指定构建目录的路径 -S 指定源代码目录</a></li></ul></li><li><a href=#3-command-命令>3. Command 命令</a><ul><li><a href=#31-set-系列>3.1 set 系列</a><ul><li><a href=#311-set-normal-value>3.1.1 Set Normal Value</a></li><li><a href=#312-set-cache-entry>3.1.2 Set Cache Entry</a></li></ul></li><li><a href=#32-add-系列>3.2 add 系列</a><ul><li><a href=#321-添加编译选项-add_compilie_options>3.2.1 添加编译选项 add_compilie_options</a></li></ul></li><li><a href=#33-message>3.3 message</a></li><li><a href=#34-function>3.4 function</a></li><li><a href=#35-list>3.5 list</a></li></ul></li><li><a href=#4-属性-property>4. 属性 Property</a></li><li><a href=#5-模块和包管理-module-package>5. 模块和包管理 module, package</a></li><li><a href=#object-file-and-link>Object file and link</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></nav></div></main><footer id=footer class=site-footer><div class=social-icon-links><a href=mailto:huwm1@shanghaitech.edu.cn rel="me noopener" class=social-icon-link title=email><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 1451 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a><a href=http://localhost:1313 rel="me noopener" class=social-icon-link title=linkedin target=_blank><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 1024 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M872.405333 872.618667H720.768V635.008c0-56.661333-1.152-129.578667-79.018667-129.578667-79.061333.0-91.136 61.653333-91.136 125.397334v241.792H398.976V384H544.64v66.602667h1.962667c20.352-38.4 69.845333-78.933333 143.786666-78.933334 153.642667.0 182.058667 101.12 182.058667 232.746667v268.202667zM227.712 317.141333a87.978667 87.978667.0 01-88.021333-88.106666A88.064 88.064.0 11227.712 317.141333zm76.032 555.477334H151.68V384h152.064v488.618667zM948.266667.0h-872.704C33.792.0.0 33.024.0 73.770667v876.458666C0 991.018667 33.792 1024 75.562667 1024h872.576C989.866667 1024 1024 991.018667 1024 950.229333V73.770667C1024 33.024 989.866667.0 948.138667.0h.128z"/></svg>
</a><a href=https://github.com/huweim rel="me noopener" class=social-icon-link title=github target=_blank><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 1024 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a><a href=https://www.zhihu.com/people/hu-wei-ming-31-86 rel="me noopener" class=social-icon-link title=zhihu target=_blank><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 1024 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M351.791182 562.469462h192.945407c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262h159.282726s-.86367-67.402109-18.578124-67.402109-279.979646.0-279.979646.0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461s24.62791 5.832845 36.941354.0c12.313443-5.832845 68.050885-25.924439 84.252893-103.69571h86.570681c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262H109.86113c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449H279.868105c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513.0.0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-.055259.185218 167.855986 193.263655s22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-.045025.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"/><path d="M584.918753 182.033893v668.840094h70.318532l28.807093 80.512708 121.875768-80.512708h153.600307L959.520453 182.033893h-374.6017zM887.150192 778.934538h-79.837326l-99.578949 65.782216-23.537066-65.782216h-24.855084L659.341766 256.673847h227.807403V778.934538z"/></svg>
</a><a href=https://huweim.github.io/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2020 -
2025
<span class=heart><i class=iconfont><svg aria-hidden="true" class="lucide lucide-heart hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5.0 0016.5 3c-1.76.0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5.0 002 8.5c0 2.3 1.5 4.05 3 5.5l7 7z"/></svg>
</i></span><span class=author>Weiming Hu</span></span></div></footer><script type=text/javascript src=/js/main.eb94e793601239645bc98e36c443aef1b210646ccb43e2217ea949a0212e0ed1.js integrity="sha256-65Tnk2ASOWRbyY42xEOu8bIQZGzLQ+IhfqlJoCEuDtE=" crossorigin=anonymous></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>